<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ZingMp3 Player API</title>
  <style>
    /* Gi·ªØ l·∫°i giao di·ªán ƒë·∫πp */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: system-ui, -apple-system, sans-serif; 
      background: linear-gradient(135deg, #0b1020 0%, #1a1f3a 100%); 
      color: #e5e7eb; 
      padding: 20px;
      min-height: 100vh;
    }
    .container { max-width: 1000px; margin: 0 auto; }
    h1 { margin-bottom: 24px; color: #60a5fa; text-align: center; }
    .card { 
      background: #111827; 
      border: 1px solid #374151; 
      border-radius: 12px; 
      padding: 20px; 
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    .group-title { color: #fcd34d; font-weight: 700; margin-bottom: 12px; border-bottom: 1px solid #374151; padding-bottom: 8px; }
    label { display: block; margin-bottom: 6px; color: #93c5fd; font-size: 14px; }
    input[type="text"] { 
      width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #374151; 
      background: #0f172a; color: white; margin-bottom: 10px;
    }
    button { 
      background: #2563eb; color: white; border: none; border-radius: 8px; 
      padding: 10px 16px; cursor: pointer; font-weight: 600; transition: 0.2s;
    }
    button:hover { background: #1d4ed8; transform: translateY(-1px); }
    .row { display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-end; }
    .w-full { width: 100%; }
    pre { 
      background: #0f172a; color: #d1d5db; padding: 15px; border-radius: 8px; 
      overflow: auto; max-height: 400px; font-size: 13px; font-family: monospace;
    }
    audio { width: 100%; margin-top: 15px; border-radius: 8px; }
    .hidden { display: none; }
    .link-display { color: #10b981; font-size: 13px; margin-top: 10px; word-break: break-all; display: block; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéµ ZingMp3 API Player</h1>

    <div class="card">
      <div class="group-title">1. T√¨m ki·∫øm b√†i h√°t</div>
      <div class="row">
        <div style="flex-grow: 1;">
          <label>Nh·∫≠p t√™n b√†i h√°t / ca sƒ©:</label>
          <input id="kw" type="text" placeholder="V√≠ d·ª•: S∆°n T√πng MTP, L·∫°c Tr√¥i..." />
        </div>
        <div>
          <button id="btnSearchV2">üîç T√¨m ki·∫øm</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="group-title">2. Ph√°t nh·∫°c (Song ID)</div>
      <div class="row">
        <div style="flex-grow: 1;">
          <label>Song ID (T·ª± ƒë·ªông ƒëi·ªÅn khi t√¨m ki·∫øm):</label>
          <input id="songId" type="text" placeholder="V√≠ d·ª•: ZOACFBBU" />
        </div>
      </div>
      <div class="row" style="margin-top: 10px;">
        <button id="btnPlay">‚ñ∂Ô∏è Ph√°t nh·∫°c</button>
        <button id="btnGetLink" style="background: #4b5563">üîó Link Stream</button>
        <button id="btnInfoSong" style="background: #4b5563">‚ÑπÔ∏è Th√¥ng tin</button>
        <button id="btnLyric" style="background: #4b5563">üìù L·ªùi b√†i h√°t</button>
      </div>

      <div id="playerContainer" class="hidden">
        <audio id="player" controls autoplay></audio>
        <a id="direct128" class="link-display" target="_blank"></a>
        <div style="margin-top:5px; font-size: 12px; color: #9ca3af;">
          *Server ƒëang proxy stream ƒë·ªÉ v∆∞·ª£t qua ch·∫∑n qu·ªëc gia.
        </div>
      </div>
    </div>

    <div class="card">
      <div class="group-title">K·∫øt qu·∫£ tr·∫£ v·ªÅ</div>
      <pre id="out">(Ch∆∞a c√≥ d·ªØ li·ªáu)</pre>
    </div>
  </div>

  <script>
    const out = document.getElementById('out');
    const setOut = (d) => out.textContent = typeof d === 'string' ? d : JSON.stringify(d, null, 2);

    // Helper: L·∫•y tr∆∞·ªùng d·ªØ li·ªáu c·∫ßn thi·∫øt cho g·ªçn
    function pickSongFields(s) {
      return {
        encodeId: s?.encodeId,
        title: s?.title,
        artistsNames: s?.artistsNames,
        duration: s?.duration
      };
    }

    // H√†m g·ªçi API
    async function call(path, params) {
      const url = new URL(path, window.location.origin);
      if (params) Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));
      
      setOut('‚è≥ ƒêang t·∫£i...');
      try {
        const res = await fetch(url);
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`L·ªói HTTP ${res.status}: ${text}`);
        }
        return await res.json();
      } catch (e) {
        throw e;
      }
    }

    // --- X·ª¨ L√ù S·ª∞ KI·ªÜN ---

    // 1. T√¨m ki·∫øm
    document.getElementById('btnSearchV2').onclick = async () => {
      const q = document.getElementById('kw').value.trim();
      if (!q) return alert('Vui l√≤ng nh·∫≠p t·ª´ kh√≥a!');

      try {
        const res = await call('/api/search', { q });
        const songs = Array.isArray(res?.data?.songs) ? res.data.songs : [];
        const concise = songs.map(pickSongFields);
        
        // T·ª± ƒë·ªông ƒëi·ªÅn ID b√†i ƒë·∫ßu ti√™n v√†o √¥ nh·∫≠p
        if (concise.length > 0 && concise[0].encodeId) {
          document.getElementById('songId').value = concise[0].encodeId;
        }

        setOut({ 
          msg: `T√¨m th·∫•y ${concise.length} b√†i h√°t.`,
          top_result: concise 
        });
      } catch (e) {
        setOut('‚ùå L·ªói: ' + String(e));
      }
    };

    // Enter ƒë·ªÉ t√¨m ki·∫øm
    document.getElementById('kw').addEventListener('keypress', (e) => {
        if(e.key === 'Enter') document.getElementById('btnSearchV2').click();
    });

    // 2. Ph√°t nh·∫°c
    const player = document.getElementById('player');
    const playerContainer = document.getElementById('playerContainer');
    const directLink = document.getElementById('direct128');

    document.getElementById('btnPlay').onclick = () => {
      const id = document.getElementById('songId').value.trim();
      if (!id) return alert('Vui l√≤ng nh·∫≠p Song ID (ho·∫∑c t√¨m ki·∫øm tr∆∞·ªõc)');

      // URL proxy stream c·ªßa server
      const streamUrl = `/api/song/stream?id=${encodeURIComponent(id)}`;
      
      // Hi·ªÉn th·ªã player
      playerContainer.classList.remove('hidden');
      
      // G√°n source v√† ph√°t
      player.src = streamUrl;
      player.load();
      player.play().catch(e => console.error("Auto-play blocked:", e));

      // Hi·ªÉn th·ªã link
      directLink.href = streamUrl;
      directLink.textContent = `üîó Link Stream tr·ª±c ti·∫øp: ${window.location.origin}${streamUrl}`;
      
      setOut(`‚ñ∂Ô∏è ƒêang ph√°t b√†i h√°t ID: ${id}\nLink: ${streamUrl}`);
    };

    // 3. L·∫•y Link JSON
    document.getElementById('btnGetLink').onclick = async () => {
      const id = document.getElementById('songId').value.trim();
      if (!id) return alert('Thi·∫øu Song ID');
      try {
        const res = await call('/api/song', { id });
        setOut(res);
      } catch (e) { setOut(String(e)); }
    };

    // 4. L·∫•y th√¥ng tin
    document.getElementById('btnInfoSong').onclick = async () => {
      const id = document.getElementById('songId').value.trim();
      if (!id) return alert('Thi·∫øu Song ID');
      try {
        const res = await call('/api/info-song', { id });
        setOut(res);
      } catch (e) { setOut(String(e)); }
    };

    // 5. L·∫•y l·ªùi b√†i h√°t
    document.getElementById('btnLyric').onclick = async () => {
      const id = document.getElementById('songId').value.trim();
      if (!id) return alert('Thi·∫øu Song ID');
      
      try {
        const res = await call('/api/lyric', { id });
        const fileUrl = res?.data?.file;
        
        if (fileUrl) {
          // Fetch file l·ªùi b√†i h√°t
          setOut('‚è≥ ƒêang t·∫£i file l·ªùi b√†i h√°t...');
          const resp = await fetch(fileUrl);
          const lrcText = await resp.text();
          
          // L·ªçc b·ªè timestamp [00:00.00] ƒë·ªÉ d·ªÖ ƒë·ªçc
          const cleanText = lrcText
            .split('\n')
            .map(line => line.replace(/\[.*?\]/g, '').trim())
            .filter(line => line)
            .join('\n');

          setOut(`üìù L·ªùi b√†i h√°t:\n\n${cleanText}`);
        } else {
          setOut(res);
        }
      } catch (e) { setOut(String(e)); }
    };
  </script>
</body>
</html>
